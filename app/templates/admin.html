<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&amp;family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&amp;family=Raleway:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&amp;display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400&amp;display=swap" rel="stylesheet">

    <!-- Vendor CSS Files (из smartio_platform_landing.html) -->
    <link href="{{ url_for('static', path='vendor/aos/aos.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSC鉴定" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="{{ url_for('static', path='vendor/swiper/swiper-bundle.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', path='vendor/glightbox/css/glightbox.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', path='vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', path='vendor/bootstrap-icons/bootstrap-icons.css') }}" rel="stylesheet">

    <!-- Main CSS File (предполагаем, что у вас есть общий файл стилей) -->
    <link href="{{ url_for('static', path='stylesheets/styles.css') }}" rel="stylesheet">

    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            display: flex;
            min-height: 100vh;
        }
        #sidebar {
            width: 250px;
            background-color: #343a40; /* Dark background */
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #sidebar .nav-link {
            color: #adb5bd; /* Lighter gray for links */
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #sidebar .nav-link:hover, #sidebar .nav-link.active {
            background-color: #495057;
            color: white;
        }
        #main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: #f8f9fa;
        }
        .header-admin {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 30px;
        }
        .header-admin h1 {
            font-size: 2rem;
            color: #333;
            margin: 0;
        }
        .header-admin .user-info {
            font-size: 1.1rem;
            color: #555;
        }
        .header-admin .user-info strong {
            color: #007bff;
        }
        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .table-responsive {
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        .table {
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .table th, .table td {
            vertical-align: middle;
            padding: 12px 15px;
        }
        .table thead th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
        }
        .btn-action {
            margin-right: 5px;
            padding: 6px 10px;
            font-size: 0.9rem;
            border-radius: 5px;
        }
        .btn-add {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .btn-add:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        .btn-edit {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
        }
        .btn-edit:hover {
            background-color: #e0a800;
            border-color: #cc9a00;
        }
        .btn-delete {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        .form-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .form-section h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }
        .form-control {
            border-radius: 5px;
        }
        .modal-content {
            border-radius: 10px;
        }
        .modal-header {
            border-bottom: none;
            padding-bottom: 0;
        }
        .modal-footer {
            border-top: none;
            padding-top: 0;
        }
        .alert-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 500;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2 class="text-center mb-4">Админ-Панель</h2>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#" data-section="subscription-types">
                    <i class="fas fa-tags me-2"></i> Типы Подписок
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="clients">
                    <i class="fas fa-users me-2"></i> Клиенты
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="blog-posts">
                    <i class="fas fa-blog me-2"></i> Блоги
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-section="future-plans">
                    <i class="fas fa-lightbulb me-2"></i> Будущие Планы
                </a>
            </li>
        </ul>
        <div class="mt-auto pt-3 border-top border-secondary">
            <p class="text-muted mb-2">Вошли как: <strong id="displayAdminUsername">{{ current_admin_username }}</strong></p>
            <button id="logoutButton" class="btn btn-danger w-100"><i class="fas fa-sign-out-alt me-2"></i> Выйти</button>
        </div>
    </div>

    <div id="main-content">
        <div class="header-admin">
            <h1>Управление SMARTIO</h1>
            <div>
                <a href="/" class="btn btn-primary"><i class="fas fa-home me-2"></i> На главную</a>
            </div>
        </div>

        <div id="content-area">
            <!-- Динамический контент будет загружаться сюда -->
            <h2 class="text-center text-muted">Выберите раздел в меню слева.</h2>
        </div>
    </div>

    <!-- Modals for Subscription Types -->
    <!-- Add Subscription Type Modal -->
    <div class="modal fade" id="addSubscriptionTypeModal" tabindex="-1" aria-labelledby="addSubscriptionTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSubscriptionTypeModalLabel">Добавить новый тип подписки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addSubscriptionTypeForm">
                        <div class="mb-3">
                            <label for="newSubscriptionTypeName" class="form-label">Название</label>
                            <input type="text" class="form-control" id="newSubscriptionTypeName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newSubscriptionTypeOptions" class="form-label">Опции (через запятую)</label>
                            <input type="text" class="form-control" id="newSubscriptionTypeOptions">
                        </div>
                        <div class="mb-3">
                            <label for="newSubscriptionTypePrice" class="form-label">Цена</label>
                            <input type="number" step="0.01" class="form-control" id="newSubscriptionTypePrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="newSubscriptionTypeDiscount" class="form-label">Скидка (%)</label>
                            <input type="number" step="0.01" class="form-control" id="newSubscriptionTypeDiscount" value="0">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="newSubscriptionTypeIsActive" checked>
                            <label class="form-check-label" for="newSubscriptionTypeIsActive">Активен</label>
                        </div>
                        <div id="addSubscriptionTypeMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Subscription Type Modal -->
    <div class="modal fade" id="editSubscriptionTypeModal" tabindex="-1" aria-labelledby="editSubscriptionTypeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSubscriptionTypeModalLabel">Редактировать тип подписки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editSubscriptionTypeForm">
                        <input type="hidden" id="editSubscriptionTypeId">
                        <div class="mb-3">
                            <label for="editSubscriptionTypeName" class="form-label">Название</label>
                            <input type="text" class="form-control" id="editSubscriptionTypeName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSubscriptionTypeOptions" class="form-label">Опции (через запятую)</label>
                            <input type="text" class="form-control" id="editSubscriptionTypeOptions">
                        </div>
                        <div class="mb-3">
                            <label for="editSubscriptionTypePrice" class="form-label">Цена</label>
                            <input type="number" step="0.01" class="form-control" id="editSubscriptionTypePrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="editSubscriptionTypeDiscount" class="form-label">Скидка (%)</label>
                            <input type="number" step="0.01" class="form-control" id="editSubscriptionTypeDiscount">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editSubscriptionTypeIsActive">
                            <label class="form-check-label" for="editSubscriptionTypeIsActive">Активен</label>
                        </div>
                        <div id="editSubscriptionTypeMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Сохранить изменения</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Blog Posts -->
    <!-- Add Blog Post Modal -->
    <div class="modal fade" id="addBlogPostModal" tabindex="-1" aria-labelledby="addBlogPostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBlogPostModalLabel">Добавить новую статью блога</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addBlogPostForm" enctype="multipart/form-data"> <!-- Добавлен enctype -->
                        <div class="mb-3">
                            <label for="newBlogPostTitle" class="form-label">Заголовок</label>
                            <input type="text" class="form-control" id="newBlogPostTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="newBlogPostShortDescription" class="form-label">Краткое описание</label>
                            <textarea class="form-control" id="newBlogPostShortDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newBlogPostContent" class="form-label">Содержание (HTML/Markdown)</label>
                            <textarea class="form-control" id="newBlogPostContent" rows="10" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newBlogPostImageFile" class="form-label">Файл изображения</label>
                            <input type="file" class="form-control" id="newBlogPostImageFile" accept="image/*"> <!-- Изменено на type="file" -->
                        </div>
                        <div class="mb-3">
                            <label for="newBlogPostVideoFile" class="form-label">Файл видео</label>
                            <input type="file" class="form-control" id="newBlogPostVideoFile" accept="video/*"> <!-- Изменено на type="file" -->
                        </div>
                        <div class="mb-3">
                            <label for="newBlogPostTags" class="form-label">Теги (через запятую)</label>
                            <input type="text" class="form-control" id="newBlogPostTags">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="newBlogPostIsPublished" checked>
                            <label class="form-check-label" for="newBlogPostIsPublished">Опубликовано</label>
                        </div>
                        <div id="addBlogPostMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Добавить статью</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Blog Post Modal -->
    <div class="modal fade" id="editBlogPostModal" tabindex="-1" aria-labelledby="editBlogPostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBlogPostModalLabel">Редактировать статью блога</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBlogPostForm" enctype="multipart/form-data"> <!-- Добавлен enctype -->
                        <input type="hidden" id="editBlogPostId">
                        <div class="mb-3">
                            <label for="editBlogPostTitle" class="form-label">Заголовок</label>
                            <input type="text" class="form-control" id="editBlogPostTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBlogPostShortDescription" class="form-label">Краткое описание</lаbel>
                            <textarea class="form-control" id="editBlogPostShortDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editBlogPostContent" class="form-label">Содержание (HTML/Markdown)</label>
                            <textarea class="form-control" id="editBlogPostContent" rows="10" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editBlogPostImageFile" class="form-label">Файл изображения (оставьте пустым, чтобы не менять)</label>
                            <input type="file" class="form-control" id="editBlogPostImageFile" accept="image/*"> <!-- Изменено на type="file" -->
                            <div id="currentImagePreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editBlogPostVideoFile" class="form-label">Файл видео (оставьте пустым, чтобы не менять)</label>
                            <input type="file" class="form-control" id="editBlogPostVideoFile" accept="video/*"> <!-- Изменено на type="file" -->
                            <div id="currentVideoPreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editBlogPostTags" class="form-label">Теги (через запятую)</label>
                            <input type="text" class="form-control" id="editBlogPostTags">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editBlogPostIsPublished">
                            <label class="form-check-label" for="editBlogPostIsPublished">Опубликовано</label>
                        </div>
                        <div id="editBlogPostMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Сохранить изменения</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for Clients -->
    <!-- Add Client Modal -->
    <div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClientModalLabel">Добавить нового клиента</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addClientForm">
                        <div class="mb-3">
                            <label for="newClientUsername" class="form-label">Имя пользователя</label>
                            <input type="text" class="form-control" id="newClientUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientPassword" class="form-label">Пароль</label>
                            <input type="password" class="form-control" id="newClientPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientCompanyName" class="form-label">Название компании</label>
                            <input type="text" class="form-control" id="newClientCompanyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientCompanyType" class="form-label">Тип компании</label>
                            <select class="form-select" id="newClientCompanyType" required>
                                <option value="">Выберите тип</option>
                                <option value="ИП">ИП</option>
                                <option value="ООО">ООО</option>
                                <option value="Другое">Другое</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newClientINN" class="form-label">ИНН</label>
                            <input type="text" class="form-control" id="newClientINN">
                        </div>
                        <div class="mb-3">
                            <label for="newClientContactEmail" class="form-label">Контактный Email</label>
                            <input type="email" class="form-control" id="newClientContactEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newClientPhoneNumber" class="form-label">Номер телефона</label>
                            <input type="text" class="form-control" id="newClientPhoneNumber">
                        </div>
                        <div class="mb-3">
                            <label for="newClientSubscriptionTypeId" class="form-label">Тип подписки</label>
                            <select class="form-select" id="newClientSubscriptionTypeId" required>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="newClientIsActive" checked>
                            <label class="form-check-label" for="newClientIsActive">Активен</label>
                        </div>
                        <div id="addClientMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Добавить клиента</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editClientModalLabel">Редактировать клиента</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editClientForm">
                        <input type="hidden" id="editClientId">
                        <div class="mb-3">
                            <label for="editClientUsername" class="form-label">Имя пользователя</label>
                            <input type="text" class="form-control" id="editClientUsername" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editClientPassword" class="form-label">Новый пароль (оставьте пустым, чтобы не менять)</label>
                            <input type="password" class="form-control" id="editClientPassword">
                        </div>
                        <div class="mb-3">
                            <label for="editClientCompanyName" class="form-label">Название компании</label>
                            <input type="text" class="form-control" id="editClientCompanyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editClientCompanyType" class="form-label">Тип компании</label>
                            <select class="form-select" id="editClientCompanyType" required>
                                <option value="ИП">ИП</option>
                                <option value="ООО">ООО</option>
                                <option value="Другое">Другое</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editClientINN" class="form-label">ИНН</label>
                            <input type="text" class="form-control" id="editClientINN">
                        </div>
                        <div class="mb-3">
                            <label for="editClientContactEmail" class="form-label">Контактный Email</label>
                            <input type="email" class="form-control" id="editClientContactEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editClientPhoneNumber" class="form-label">Номер телефона</label>
                            <input type="text" class="form-control" id="editClientPhoneNumber">
                        </div>
                        <div class="mb-3">
                            <label for="editClientSubscriptionTypeId" class="form-label">Тип подписки</label>
                            <select class="form-select" id="editClientSubscriptionTypeId" required>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editClientIsActive">
                            <label class="form-check-label" for="editClientIsActive">Активен</label>
                        </div>
                        <div id="editClientMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Сохранить изменения</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Modals for Future Plans -->
    <!-- Add Future Plan Modal -->
    <div class="modal fade" id="addFuturePlanModal" tabindex="-1" aria-labelledby="addFuturePlanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFuturePlanModalLabel">Добавить новый будущий план</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addFuturePlanForm" enctype="multipart/form-data"> <!-- Добавлен enctype -->
                        <div class="mb-3">
                            <label for="newFuturePlanTitle" class="form-label">Заголовок</label>
                            <input type="text" class="form-control" id="newFuturePlanTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="newFuturePlanDescription" class="form-label">Описание</label>
                            <textarea class="form-control" id="newFuturePlanDescription" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="newFuturePlanCategory" class="form-label">Категория</label>
                            <input type="text" class="form-control" id="newFuturePlanCategory">
                        </div>
                        <div class="mb-3">
                            <label for="newFuturePlanImageFile" class="form-label">Файл изображения</label>
                            <input type="file" class="form-control" id="newFuturePlanImageFile" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="newFuturePlanVideoFile" class="form-label">Файл видео</label>
                            <input type="file" class="form-control" id="newFuturePlanVideoFile" accept="video/*">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="newFuturePlanIsActive" checked>
                            <label class="form-check-label" for="newFuturePlanIsActive">Активен</label>
                        </div>
                        <div id="addFuturePlanMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Добавить план</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Future Plan Modal -->
    <div class="modal fade" id="editFuturePlanModal" tabindex="-1" aria-labelledby="editFuturePlanModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editFuturePlanModalLabel">Редактировать будущий план</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editFuturePlanForm" enctype="multipart/form-data"> <!-- Добавлен enctype -->
                        <input type="hidden" id="editFuturePlanId">
                        <div class="mb-3">
                            <label for="editFuturePlanTitle" class="form-label">Заголовок</label>
                            <input type="text" class="form-control" id="editFuturePlanTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editFuturePlanDescription" class="form-label">Описание</label>
                            <textarea class="form-control" id="editFuturePlanDescription" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editFuturePlanCategory" class="form-label">Категория</label>
                            <input type="text" class="form-control" id="editFuturePlanCategory">
                        </div>
                        <div class="mb-3">
                            <label for="editFuturePlanImageFile" class="form-label">Файл изображения (оставьте пустым, чтобы не менять)</label>
                            <input type="file" class="form-control" id="editFuturePlanImageFile" accept="image/*">
                            <div id="currentFuturePlanImagePreview" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label for="editFuturePlanVideoFile" class="form-label">Файл видео (оставьте пустым, чтобы не менять)</label>
                            <input type="file" class="form-control" id="editFuturePlanVideoFile" accept="video/*">
                            <div id="currentFuturePlanVideoPreview" class="mt-2"></div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editFuturePlanIsActive">
                            <label class="form-check-label" for="editFuturePlanIsActive">Активен</label>
                        </div>
                        <div id="editFuturePlanMessage" class="alert-message hidden"></div>
                        <button type="submit" class="btn btn-primary w-100">Сохранить изменения</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Vendor JS Files (из smartio_platform_landing.html) -->
    <script src="{{ url_for('static', path='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', path='javascripts/jquery.min.js') }}"></script>
    <script>
        // Helper function to show messages
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert-message alert-${type}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const adminAccessToken = localStorage.getItem('admin_access_token');
            const displayAdminUsername = document.getElementById('displayAdminUsername');
            const contentArea = document.getElementById('content-area');
            const logoutButton = document.getElementById('logoutButton');

            // --- Initial Authentication Check ---
            if (!adminAccessToken) {
                window.location.href = '/admin/login';
                return;
            }

            try {
                const response = await fetch('/api/admin/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${adminAccessToken}`
                    }
                });

                if (response.ok) {
                    const adminData = await response.json();
                    displayAdminUsername.textContent = adminData.username;
                } else if (response.status === 401) {
                    // Токен недействителен или истек - сразу перенаправляем
                    window.location.href = '/admin/login';
                } else {
                    // В случае других ошибок, также перенаправляем на логин
                    console.error('Failed to fetch admin data:', response.status, response.statusText);
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                console.error('Ошибка сети при загрузке данных администратора:', error);
                // При ошибке сети также перенаправляем
                window.location.href = '/admin/login';
            }

            // --- Logout Functionality ---
            logoutButton.addEventListener('click', function() {
                localStorage.removeItem('admin_access_token');
                window.location.href = '/admin/login';
            });

            // --- Navigation Logic ---
            const navLinks = document.querySelectorAll('#sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    const section = this.dataset.section;
                    loadSection(section);
                });
            });

            // --- Section Loading Functions ---
            async function loadSection(sectionName) {
                contentArea.innerHTML = '<div class="text-center text-muted">Загрузка...</div>'; // Loading indicator
                switch (sectionName) {
                    case 'subscription-types':
                        await renderSubscriptionTypes();
                        break;
                    case 'clients':
                        await renderClients();
                        break;
                    case 'blog-posts':
                        await renderBlogPosts();
                        break;
                    case 'future-plans':
                        await renderFuturePlans();
                        break;
                    default:
                        contentArea.innerHTML = '<h2 class="text-center text-muted">Выберите раздел в меню слева.</h2>';
                }
            }

            // --- Render Subscription Types Section ---
            async function renderSubscriptionTypes() {
                contentArea.innerHTML = `
                    <h2 class="section-title">Управление Типами Подписок</h2>
                    <button class="btn btn-add mb-3" data-bs-toggle="modal" data-bs-target="#addSubscriptionTypeModal">
                        <i class="fas fa-plus-circle me-2"></i> Добавить новый тип
                    </button>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Опции</th>
                                    <th>Цена</th>
                                    <th>Скидка (%)</th>
                                    <th>Активен</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionTypesTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="subscriptionTypesMessage" class="alert-message hidden"></div>
                `;
                await fetchSubscriptionTypes();
            }

            async function fetchSubscriptionTypes() {
                try {
                    const response = await fetch('/api/admin/subscription_types/', {
                        headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                    });
                    if (response.ok) {
                        const types = await response.json();
                        const tbody = document.getElementById('subscriptionTypesTableBody');
                        tbody.innerHTML = ''; // Clear existing rows
                        types.forEach(type => {
                            const row = tbody.insertRow(); // Исправлено: insertRow() вместо insertCell()
                            row.insertCell().textContent = type.id;
                            row.insertCell().textContent = type.name;
                            row.insertCell().textContent = type.options.join(', ');
                            row.insertCell().textContent = `$${type.price.toFixed(2)}`;
                            row.insertCell().textContent = `${type.discount}%`;
                            row.insertCell().textContent = type.is_active ? 'Да' : 'Нет';
                            const actionsCell = row.insertCell();
                            actionsCell.innerHTML = `
                                <button class="btn btn-edit btn-action" data-id="${type.id}" data-bs-toggle="modal" data-bs-target="#editSubscriptionTypeModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-delete btn-action" data-id="${type.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                        });
                        // Attach event listeners to new buttons
                        attachSubscriptionTypeEventListeners();
                    } else {
                        const errorData = await response.json(); // Try to parse error details
                        console.error('Failed to fetch subscription types:', response.status, response.statusText, errorData);
                        showMessage('subscriptionTypesMessage', `Не удалось загрузить типы подписок: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching subscription types:', error);
                    showMessage('subscriptionTypesMessage', 'Ошибка сети при загрузке типов подписок. Проверьте консоль для получения подробной информации.', 'danger');
                }
            }

            function attachSubscriptionTypeEventListeners() {
                document.querySelectorAll('#subscriptionTypesTableBody .btn-edit').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        try {
                            const response = await fetch(`/api/admin/subscription_types/${id}`, {
                                headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                            });
                            if (response.ok) {
                                const type = await response.json();
                                document.getElementById('editSubscriptionTypeId').value = type.id;
                                document.getElementById('editSubscriptionTypeName').value = type.name;
                                document.getElementById('editSubscriptionTypeOptions').value = type.options.join(', ');
                                document.getElementById('editSubscriptionTypePrice').value = type.price;
                                document.getElementById('editSubscriptionTypeDiscount').value = type.discount;
                                document.getElementById('editSubscriptionTypeIsActive').checked = type.is_active;
                                // Clear previous messages
                                document.getElementById('editSubscriptionTypeMessage').classList.add('hidden');
                            } else {
                                const errorData = await response.json();
                                console.error('Failed to load subscription type for edit:', response.status, response.statusText, errorData);
                                showMessage('subscriptionTypesMessage', `Не удалось загрузить тип подписки для редактирования: ${errorData.detail || response.statusText}`, 'danger');
                            }
                        } catch (error) {
                            console.error('Error fetching subscription type for edit:', error);
                            showMessage('subscriptionTypesMessage', 'Ошибка сети при загрузке типа подписки для редактирования.', 'danger');
                        }
                    };
                });

                document.querySelectorAll('#subscriptionTypesTableBody .btn-delete').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        if (confirm(`Вы уверены, что хотите удалить тип подписки с ID ${id}?`)) {
                            try {
                                const response = await fetch(`/api/admin/subscription_types/${id}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                                });
                                if (response.status === 204) {
                                    showMessage('subscriptionTypesMessage', 'Тип подписки успешно удален.', 'success');
                                    await fetchSubscriptionTypes(); // Refresh table
                                } else {
                                    const errorData = await response.json();
                                    showMessage('subscriptionTypesMessage', `Ошибка удаления: ${errorData.detail || response.statusText}`, 'danger');
                                }
                            } catch (error) {
                                console.error('Error deleting subscription type:', error);
                                showMessage('subscriptionTypesMessage', 'Ошибка сети при удалении типа подписки.', 'danger');
                            }
                        }
                    };
                });
            }

            // Add Subscription Type Form Submission
            document.getElementById('addSubscriptionTypeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('newSubscriptionTypeName').value;
                const options = document.getElementById('newSubscriptionTypeOptions').value.split(',').map(s => s.trim()).filter(s => s);
                const price = parseFloat(document.getElementById('newSubscriptionTypePrice').value);
                const discount = parseFloat(document.getElementById('newSubscriptionTypeDiscount').value);
                const isActive = document.getElementById('newSubscriptionTypeIsActive').checked;

                try {
                    const response = await fetch('/api/admin/subscription_types/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminAccessToken}`
                        },
                        body: JSON.stringify({ name, options, price, discount, is_active: isActive })
                    });
                    if (response.ok) {
                        showMessage('addSubscriptionTypeMessage', 'Тип подписки успешно добавлен!', 'success');
                        $('#addSubscriptionTypeModal').modal('hide'); // Hide modal
                        this.reset(); // Clear form
                        await fetchSubscriptionTypes(); // Refresh table
                    } else {
                        const errorData = await response.json();
                        showMessage('addSubscriptionTypeMessage', `Ошибка добавления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error adding subscription type:', error);
                    showMessage('addSubscriptionTypeMessage', 'Ошибка сети при добавлении типа подписки.', 'danger');
                }
            });

            // Edit Subscription Type Form Submission
            document.getElementById('editSubscriptionTypeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('editSubscriptionTypeId').value;
                const name = document.getElementById('editSubscriptionTypeName').value;
                const options = document.getElementById('editSubscriptionTypeOptions').value.split(',').map(s => s.trim()).filter(s => s);
                const price = parseFloat(document.getElementById('editSubscriptionTypePrice').value);
                const discount = parseFloat(document.getElementById('editSubscriptionTypeDiscount').value);
                const isActive = document.getElementById('editSubscriptionTypeIsActive').checked;

                try {
                    const response = await fetch(`/api/admin/subscription_types/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminAccessToken}`
                        },
                        body: JSON.stringify({ name, options, price, discount, is_active: isActive })
                    });
                    if (response.ok) {
                        showMessage('editSubscriptionTypeMessage', 'Тип подписки успешно обновлен!', 'success');
                        $('#editSubscriptionTypeModal').modal('hide'); // Hide modal
                        await fetchSubscriptionTypes(); // Refresh table
                    } else {
                        const errorData = await response.json();
                        showMessage('editSubscriptionTypeMessage', `Ошибка обновления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error updating subscription type:', error);
                    showMessage('editSubscriptionTypeMessage', 'Ошибка сети при обновлении типа подписки.', 'danger');
                }
            });

            // --- Render Clients Section ---
            let allSubscriptionTypes = []; // Store subscription types for client modals

            async function renderClients() {
                contentArea.innerHTML = `
                    <h2 class="section-title">Управление Клиентами</h2>
                    <button class="btn btn-add mb-3" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="fas fa-plus-circle me-2"></i> Добавить нового клиента
                    </button>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя пользователя</th>
                                    <th>Компания</th>
                                    <th>Тип компании</th>
                                    <th>ИНН</th>
                                    <th>Email</th>
                                    <th>Телефон</th>
                                    <th>Подписка</th>
                                    <th>Активен</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="clientsMessage" class="alert-message hidden"></div>
                `;
                await fetchClients();
            }

            async function fetchClients() {
                try {
                    // Fetch subscription types first to populate dropdowns
                    const subTypesResponse = await fetch('/api/admin/subscription_types/', {
                        headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                    });
                    if (subTypesResponse.ok) {
                        allSubscriptionTypes = await subTypesResponse.json();
                        populateSubscriptionTypeDropdowns(); // Populate dropdowns after fetching
                    } else {
                        const errorData = await subTypesResponse.json();
                        console.error('Failed to load subscription types for client forms:', subTypesResponse.status, subTypesResponse.statusText, errorData);
                        showMessage('clientsMessage', `Не удалось загрузить типы подписок для форм клиентов: ${errorData.detail || subTypesResponse.statusText}`, 'danger');
                        allSubscriptionTypes = []; // Ensure it's empty on failure
                    }

                    const response = await fetch('/api/admin/clients/', {
                        headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                    });
                    if (response.ok) {
                        const clients = await response.json();
                        const tbody = document.getElementById('clientsTableBody');
                        tbody.innerHTML = ''; // Clear existing rows
                        clients.forEach(client => {
                            const row = tbody.insertRow();
                            row.insertCell().textContent = client.id;
                            row.insertCell().textContent = client.username;
                            row.insertCell().textContent = client.company_name;
                            row.insertCell().textContent = client.company_type;
                            row.insertCell().textContent = client.inn || 'N/A';
                            row.insertCell().textContent = client.contact_email;
                            row.insertCell().textContent = client.phone_number || 'N/A';
                            row.insertCell().textContent = client.subscription_type ? client.subscription_type.name : 'Неизвестно';
                            row.insertCell().textContent = client.is_active ? 'Да' : 'Нет';
                            const actionsCell = row.insertCell();
                            actionsCell.innerHTML = `
                                <button class="btn btn-edit btn-action" data-id="${client.id}" data-bs-toggle="modal" data-bs-target="#editClientModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-delete btn-action" data-id="${client.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                        });
                        attachClientEventListeners();
                    } else {
                        const errorData = await response.json();
                        console.error('Failed to fetch clients:', response.status, response.statusText, errorData);
                        showMessage('clientsMessage', `Не удалось загрузить клиентов: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching clients:', error);
                    showMessage('clientsMessage', 'Ошибка сети при загрузке клиентов. Проверьте консоль для получения подробной информации.', 'danger');
                }
            }

            function populateSubscriptionTypeDropdowns() {
                const addDropdown = document.getElementById('newClientSubscriptionTypeId');
                const editDropdown = document.getElementById('editClientSubscriptionTypeId');

                // Clear existing options
                addDropdown.innerHTML = '<option value="">Выберите тип подписки</option>';
                editDropdown.innerHTML = ''; // Edit modal might not need a default empty option if it's always pre-selected

                allSubscriptionTypes.forEach(type => {
                    const optionAdd = document.createElement('option');
                    optionAdd.value = type.id;
                    optionAdd.textContent = `${type.name} - $${type.price.toFixed(2)}`;
                    addDropdown.appendChild(optionAdd);

                    const optionEdit = document.createElement('option');
                    optionEdit.value = type.id;
                    optionEdit.textContent = `${type.name} - $${type.price.toFixed(2)}`;
                    editDropdown.appendChild(optionEdit);
                });
            }

            function attachClientEventListeners() {
                document.querySelectorAll('#clientsTableBody .btn-edit').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        try {
                            const response = await fetch(`/api/admin/clients/${id}`, {
                                headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                            });
                            if (response.ok) {
                                const client = await response.json();
                                document.getElementById('editClientId').value = client.id;
                                document.getElementById('editClientUsername').value = client.username;
                                // Password field is intentionally left blank for security
                                document.getElementById('editClientCompanyName').value = client.company_name;
                                document.getElementById('editClientCompanyType').value = client.company_type;
                                document.getElementById('editClientINN').value = client.inn || '';
                                document.getElementById('editClientContactEmail').value = client.contact_email;
                                document.getElementById('editClientPhoneNumber').value = client.phone_number || '';
                                document.getElementById('editClientSubscriptionTypeId').value = client.subscription_type_id;
                                document.getElementById('editClientIsActive').checked = client.is_active;
                                document.getElementById('editClientMessage').classList.add('hidden');
                            } else {
                                const errorData = await response.json();
                                console.error('Failed to load client for edit:', response.status, response.statusText, errorData);
                                showMessage('clientsMessage', `Не удалось загрузить клиента для редактирования: ${errorData.detail || response.statusText}`, 'danger');
                            }
                        } catch (error) {
                            console.error('Error fetching client for edit:', error);
                            showMessage('clientsMessage', 'Ошибка сети при загрузке клиента для редактирования.', 'danger');
                        }
                    };
                });

                document.querySelectorAll('#clientsTableBody .btn-delete').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        if (confirm(`Вы уверены, что хотите удалить клиента с ID ${id}? Это действие необратимо.`)) {
                            try {
                                const response = await fetch(`/api/admin/clients/${id}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                                });
                                if (response.status === 204) {
                                    showMessage('clientsMessage', 'Клиент успешно удален.', 'success');
                                    await fetchClients(); // Refresh table
                                } else {
                                    const errorData = await response.json();
                                    showMessage('clientsMessage', `Ошибка удаления: ${errorData.detail || response.statusText}`, 'danger');
                                }
                            } catch (error) {
                                console.error('Error deleting client:', error);
                                showMessage('clientsMessage', 'Ошибка сети при удалении клиента.', 'danger');
                            }
                        }
                    };
                });
            }

            // Add Client Form Submission
            document.getElementById('addClientForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const username = document.getElementById('newClientUsername').value;
                const password = document.getElementById('newClientPassword').value;
                const companyName = document.getElementById('newClientCompanyName').value;
                const companyType = document.getElementById('newClientCompanyType').value;
                const inn = document.getElementById('newClientINN').value || null;
                const contactEmail = document.getElementById('newClientContactEmail').value;
                const phoneNumber = document.getElementById('newClientPhoneNumber').value || null;
                const subscriptionTypeId = parseInt(document.getElementById('newClientSubscriptionTypeId').value);
                const isActive = document.getElementById('newClientIsActive').checked;

                try {
                    const response = await fetch('/api/admin/clients/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminAccessToken}`
                        },
                        body: JSON.stringify({
                            username, password, company_name: companyName, company_type: companyType,
                            inn, contact_email: contactEmail, phone_number: phoneNumber,
                            subscription_type_id: subscriptionTypeId, is_active: isActive
                        })
                    });
                    if (response.ok) {
                        showMessage('addClientMessage', 'Клиент успешно добавлен!', 'success');
                        $('#addClientModal').modal('hide');
                        this.reset();
                        await fetchClients();
                    } else {
                        const errorData = await response.json();
                        showMessage('addClientMessage', `Ошибка добавления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error adding client:', error);
                    showMessage('addClientMessage', 'Ошибка сети при добавлении клиента.', 'danger');
                }
            });

            // Edit Client Form Submission
            document.getElementById('editClientForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('editClientId').value;
                const password = document.getElementById('editClientPassword').value; // Optional new password
                const companyName = document.getElementById('editClientCompanyName').value;
                const companyType = document.getElementById('editClientCompanyType').value;
                const inn = document.getElementById('editClientINN').value || null;
                const contactEmail = document.getElementById('editClientContactEmail').value;
                const phoneNumber = document.getElementById('editClientPhoneNumber').value || null;
                const subscriptionTypeId = parseInt(document.getElementById('editClientSubscriptionTypeId').value);
                const isActive = document.getElementById('editClientIsActive').checked;

                const updateData = {
                    company_name: companyName,
                    company_type: companyType,
                    inn: inn,
                    contact_email: contactEmail,
                    phone_number: phoneNumber,
                    subscription_type_id: subscriptionTypeId,
                    is_active: isActive
                };
                if (password) { // Only include password if it's not empty
                    updateData.password = password;
                }

                try {
                    const response = await fetch(`/api/admin/clients/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminAccessToken}`
                        },
                        body: JSON.stringify(updateData)
                    });
                    if (response.ok) {
                        showMessage('editClientMessage', 'Данные клиента успешно обновлены!', 'success');
                        $('#editClientModal').modal('hide');
                        await fetchClients();
                    } else {
                        const errorData = await response.json();
                        showMessage('editClientMessage', `Ошибка обновления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error updating client:', error);
                    showMessage('editClientMessage', 'Ошибка сети при обновлении данных клиента.', 'danger');
                }
            });

            // --- Render Blog Posts Section ---
            async function renderBlogPosts() {
                contentArea.innerHTML = `
                    <h2 class="section-title">Управление Блогами</h2>
                    <button class="btn btn-add mb-3" data-bs-toggle="modal" data-bs-target="#addBlogPostModal">
                        <i class="fas fa-plus-circle me-2"></i> Добавить новую статью
                    </button>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Заголовок</th>
                                    <th>Автор</th>
                                    <th>Изображение</th>
                                    <th>Видео</th>
                                    <th>Опубликовано</th>
                                    <th>Дата публикации</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="blogPostsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="blogPostsMessage" class="alert-message hidden"></div>
                `;
                await fetchBlogPosts();
            }

            async function fetchBlogPosts() {
                try {
                    const response = await fetch('/api/admin/blogs/', {
                        headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                    });
                    if (response.ok) {
                        const posts = await response.json();
                        const tbody = document.getElementById('blogPostsTableBody');
                        tbody.innerHTML = '';
                        posts.forEach(post => {
                            const row = tbody.insertRow();
                            row.insertCell().textContent = post.id;
                            row.insertCell().textContent = post.title;
                            row.insertCell().textContent = post.author ? post.author.username : 'Неизвестно';

                            const imageCell = row.insertCell();
                            if (post.image_url) {
                                imageCell.innerHTML = `<img src="${post.image_url}" alt="Изображение" style="max-width: 80px; height: auto; border-radius: 5px;">`;
                            } else {
                                imageCell.textContent = 'Нет';
                            }

                            const videoCell = row.insertCell();
                            if (post.video_url) {
                                videoCell.innerHTML = `<a href="${post.video_url}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-video"></i></a>`;
                            } else {
                                videoCell.textContent = 'Нет';
                            }

                            row.insertCell().textContent = post.is_published ? 'Да' : 'Нет';
                            row.insertCell().textContent = post.published_at ? new Date(post.published_at).toLocaleDateString() : 'N/A';
                            const actionsCell = row.insertCell();
                            actionsCell.innerHTML = `
                                <button class="btn btn-edit btn-action" data-id="${post.id}" data-bs-toggle="modal" data-bs-target="#editBlogPostModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-delete btn-action" data-id="${post.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                        });
                        attachBlogPostEventListeners();
                    } else {
                        const errorData = await response.json();
                        console.error('Failed to fetch blog posts:', response.status, response.statusText, errorData);
                        showMessage('blogPostsMessage', `Не удалось загрузить статьи блога: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching blog posts:', error);
                    showMessage('blogPostsMessage', 'Ошибка сети при загрузке статей блога. Проверьте консоль для получения подробной информации.', 'danger');
                }
            }

            function attachBlogPostEventListeners() {
                document.querySelectorAll('#blogPostsTableBody .btn-edit').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        try {
                            const response = await fetch(`/api/admin/blogs/${id}`, {
                                headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                            });
                            if (response.ok) {
                                const post = await response.json();
                                document.getElementById('editBlogPostId').value = post.id;
                                document.getElementById('editBlogPostTitle').value = post.title;
                                document.getElementById('editBlogPostShortDescription').value = post.short_description || '';
                                document.getElementById('editBlogPostContent').value = post.content;
                                document.getElementById('editBlogPostTags').value = post.tags.join(', ');
                                document.getElementById('editBlogPostIsPublished').checked = post.is_published;

                                // Предпросмотр текущего изображения
                                const currentImagePreview = document.getElementById('currentImagePreview');
                                currentImagePreview.innerHTML = '';
                                if (post.image_url) {
                                    currentImagePreview.innerHTML = `<img src="${post.image_url}" alt="Текущее изображение" style="max-width: 150px; height: auto; margin-top: 10px; border-radius: 5px;">`;
                                }

                                // Предпросмотр текущего видео
                                const currentVideoPreview = document.getElementById('currentVideoPreview');
                                currentVideoPreview.innerHTML = '';
                                if (post.video_url) {
                                    currentVideoPreview.innerHTML = `<a href="${post.video_url}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-video"></i> Текущее видео</a>`;
                                }

                                // Очищаем поля выбора файлов, чтобы пользователь мог выбрать новые
                                document.getElementById('editBlogPostImageFile').value = '';
                                document.getElementById('editBlogPostVideoFile').value = '';

                                document.getElementById('editBlogPostMessage').classList.add('hidden');
                            } else {
                                const errorData = await response.json();
                                console.error('Failed to load blog post for edit:', response.status, response.statusText, errorData);
                                showMessage('blogPostsMessage', `Не удалось загрузить статью для редактирования: ${errorData.detail || response.statusText}`, 'danger');
                            }
                        } catch (error) {
                            console.error('Error fetching blog post for edit:', error);
                            showMessage('blogPostsMessage', 'Ошибка сети при загрузке статьи для редактирования.', 'danger');
                        }
                    };
                });

                document.querySelectorAll('#blogPostsTableBody .btn-delete').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        if (confirm(`Вы уверены, что хотите удалить статью с ID ${id}?`)) {
                            try {
                                const response = await fetch(`/api/admin/blogs/${id}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                                });
                                if (response.status === 204) {
                                    showMessage('blogPostsMessage', 'Статья успешно удалена.', 'success');
                                    await fetchBlogPosts();
                                } else {
                                    const errorData = await response.json();
                                    showMessage('blogPostsMessage', `Ошибка удаления: ${errorData.detail || response.statusText}`, 'danger');
                                }
                            } catch (error) {
                                console.error('Error deleting blog post:', error);
                                showMessage('blogPostsMessage', 'Ошибка сети при удалении статьи.', 'danger');
                            }
                        }
                    };
                });
            }

            // Add Blog Post Form Submission
            document.getElementById('addBlogPostForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData();
                formData.append('title', document.getElementById('newBlogPostTitle').value);
                formData.append('short_description', document.getElementById('newBlogPostShortDescription').value);
                formData.append('content', document.getElementById('newBlogPostContent').value);
                formData.append('tags', document.getElementById('newBlogPostTags').value);
                formData.append('is_published', document.getElementById('newBlogPostIsPublished').checked);

                const imageFile = document.getElementById('newBlogPostImageFile').files[0];
                if (imageFile) {
                    formData.append('image_file', imageFile);
                }

                const videoFile = document.getElementById('newBlogPostVideoFile').files[0];
                if (videoFile) {
                    formData.append('video_file', videoFile);
                }

                try {
                    const response = await fetch('/api/admin/blogs/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminAccessToken}`
                            // Content-Type заголовок не устанавливается вручную для FormData
                        },
                        body: formData
                    });
                    if (response.ok) {
                        showMessage('addBlogPostMessage', 'Статья успешно добавлена!', 'success');
                        $('#addBlogPostModal').modal('hide');
                        this.reset();
                        await fetchBlogPosts();
                    } else {
                        const errorData = await response.json();
                        showMessage('addBlogPostMessage', `Ошибка добавления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error adding blog post:', error);
                    showMessage('addBlogPostMessage', 'Ошибка сети при добавлении статьи.', 'danger');
                }
            });

            // Edit Blog Post Form Submission
            document.getElementById('editBlogPostForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('editBlogPostId').value;

                const formData = new FormData();
                // Добавляем только те поля, которые были изменены или должны быть отправлены
                formData.append('title', document.getElementById('editBlogPostTitle').value);
                formData.append('short_description', document.getElementById('editBlogPostShortDescription').value);
                formData.append('content', document.getElementById('editBlogPostContent').value);
                formData.append('tags', document.getElementById('editBlogPostTags').value);
                formData.append('is_published', document.getElementById('editBlogPostIsPublished').checked);

                const imageFile = document.getElementById('editBlogPostImageFile').files[0];
                if (imageFile) {
                    formData.append('image_file', imageFile);
                } else {
                    // Важно: если пользователь не выбрал новый файл, но поле файла было очищено,
                    // это может означать желание удалить текущее изображение.
                    // FastAPI Form() параметры будут None, если файл не выбран.
                    // Если вы хотите явно удалить, можно добавить скрытое поле или отдельную кнопку.
                    // Пока оставим так, как есть, FastAPI будет обрабатывать None как отсутствие изменения.
                }

                const videoFile = document.getElementById('editBlogPostVideoFile').files[0];
                if (videoFile) {
                    formData.append('video_file', videoFile);
                } else {
                    // Аналогично для видео
                }

                try {
                    const response = await fetch(`/api/admin/blogs/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${adminAccessToken}`
                            // Content-Type заголовок не устанавливается вручную для FormData
                        },
                        body: formData
                    });
                    if (response.ok) {
                        showMessage('editBlogPostMessage', 'Статья успешно обновлена!', 'success');
                        $('#editBlogPostModal').modal('hide');
                        await fetchBlogPosts();
                    } else {
                        const errorData = await response.json();
                        showMessage('editBlogPostMessage', `Ошибка обновления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error updating blog post:', error);
                    showMessage('editBlogPostMessage', 'Ошибка сети при обновлении статьи.', 'danger');
                }
            });


            // --- Render Future Plans Section ---
            async function renderFuturePlans() {
                contentArea.innerHTML = `
                    <h2 class="section-title">Управление Будущими Планами</h2>
                    <button class="btn btn-add mb-3" data-bs-toggle="modal" data-bs-target="#addFuturePlanModal">
                        <i class="fas fa-plus-circle me-2"></i> Добавить новый план
                    </button>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Заголовок</th>
                                    <th>Описание</th>
                                    <th>Категория</th>
                                    <th>Изображение</th>
                                    <th>Видео</th>
                                    <th>Активен</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="futurePlansTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="futurePlansMessage" class="alert-message hidden"></div>
                `;
                await fetchFuturePlans();
            }

            async function fetchFuturePlans() {
                try {
                    const response = await fetch('/api/admin/future_plans/', {
                        headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                    });
                    if (response.ok) {
                        const plans = await response.json();
                        const tbody = document.getElementById('futurePlansTableBody');
                        tbody.innerHTML = '';
                        plans.forEach(plan => {
                            const row = tbody.insertRow();
                            row.insertCell().textContent = plan.id;
                            row.insertCell().textContent = plan.title;
                            row.insertCell().textContent = plan.description || 'N/A';
                            row.insertCell().textContent = plan.category || 'N/A';

                            const imageCell = row.insertCell();
                            if (plan.image_url) {
                                imageCell.innerHTML = `<img src="${plan.image_url}" alt="Изображение" style="max-width: 80px; height: auto; border-radius: 5px;">`;
                            } else {
                                imageCell.textContent = 'Нет';
                            }

                            const videoCell = row.insertCell();
                            if (plan.video_url) {
                                videoCell.innerHTML = `<a href="${plan.video_url}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-video"></i></a>`;
                            } else {
                                videoCell.textContent = 'Нет';
                            }

                            row.insertCell().textContent = plan.is_active ? 'Да' : 'Нет';
                            const actionsCell = row.insertCell();
                            actionsCell.innerHTML = `
                                <button class="btn btn-edit btn-action" data-id="${plan.id}" data-bs-toggle="modal" data-bs-target="#editFuturePlanModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-delete btn-action" data-id="${plan.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            `;
                        });
                        attachFuturePlanEventListeners();
                    } else {
                        const errorData = await response.json();
                        console.error('Failed to fetch future plans:', response.status, response.statusText, errorData);
                        showMessage('futurePlansMessage', `Не удалось загрузить будущие планы: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching future plans:', error);
                    showMessage('futurePlansMessage', 'Ошибка сети при загрузке будущих планов. Проверьте консоль для получения подробной информации.', 'danger');
                }
            }

            function attachFuturePlanEventListeners() {
                document.querySelectorAll('#futurePlansTableBody .btn-edit').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        try {
                            const response = await fetch(`/api/admin/future_plans/${id}`, {
                                headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                            });
                            if (response.ok) {
                                const plan = await response.json();
                                document.getElementById('editFuturePlanId').value = plan.id;
                                document.getElementById('editFuturePlanTitle').value = plan.title;
                                document.getElementById('editFuturePlanDescription').value = plan.description || '';
                                document.getElementById('editFuturePlanCategory').value = plan.category || '';
                                document.getElementById('editFuturePlanIsActive').checked = plan.is_active;

                                // Предпросмотр текущего изображения
                                const currentImagePreview = document.getElementById('currentFuturePlanImagePreview');
                                currentImagePreview.innerHTML = '';
                                if (plan.image_url) {
                                    currentImagePreview.innerHTML = `<img src="${plan.image_url}" alt="Текущее изображение" style="max-width: 150px; height: auto; margin-top: 10px; border-radius: 5px;">`;
                                }

                                // Предпросмотр текущего видео
                                const currentVideoPreview = document.getElementById('currentFuturePlanVideoPreview');
                                currentVideoPreview.innerHTML = '';
                                if (plan.video_url) {
                                    currentVideoPreview.innerHTML = `<a href="${plan.video_url}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-video"></i> Текущее видео</a>`;
                                }

                                // Очищаем поля выбора файлов, чтобы пользователь мог выбрать новые
                                document.getElementById('editFuturePlanImageFile').value = '';
                                document.getElementById('editFuturePlanVideoFile').value = '';

                                document.getElementById('editFuturePlanMessage').classList.add('hidden');
                            } else {
                                const errorData = await response.json();
                                console.error('Failed to load future plan for edit:', response.status, response.statusText, errorData);
                                showMessage('futurePlansMessage', `Не удалось загрузить план для редактирования: ${errorData.detail || response.statusText}`, 'danger');
                            }
                        } catch (error) {
                            console.error('Error fetching future plan for edit:', error);
                            showMessage('futurePlansMessage', 'Ошибка сети при загрузке плана для редактирования.', 'danger');
                        }
                    };
                });

                document.querySelectorAll('#futurePlansTableBody .btn-delete').forEach(button => {
                    button.onclick = async function() {
                        const id = this.dataset.id;
                        if (confirm(`Вы уверены, что хотите удалить будущий план с ID ${id}?`)) {
                            try {
                                const response = await fetch(`/api/admin/future_plans/${id}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${adminAccessToken}` }
                                });
                                if (response.status === 204) {
                                    showMessage('futurePlansMessage', 'Будущий план успешно удален.', 'success');
                                    await fetchFuturePlans();
                                } else {
                                    const errorData = await response.json();
                                    showMessage('futurePlansMessage', `Ошибка удаления: ${errorData.detail || response.statusText}`, 'danger');
                                }
                            } catch (error) {
                                console.error('Error deleting future plan:', error);
                                showMessage('futurePlansMessage', 'Ошибка сети при удалении будущего плана.', 'danger');
                            }
                        }
                    };
                });
            }

            // Add Future Plan Form Submission
            document.getElementById('addFuturePlanForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData();
                formData.append('title', document.getElementById('newFuturePlanTitle').value);
                formData.append('description', document.getElementById('newFuturePlanDescription').value || '');
                formData.append('category', document.getElementById('newFuturePlanCategory').value || '');
                formData.append('is_active', document.getElementById('newFuturePlanIsActive').checked);

                const imageFile = document.getElementById('newFuturePlanImageFile').files[0];
                if (imageFile) {
                    formData.append('image_file', imageFile);
                }

                const videoFile = document.getElementById('newFuturePlanVideoFile').files[0];
                if (videoFile) {
                    formData.append('video_file', videoFile);
                }

                try {
                    const response = await fetch('/api/admin/future_plans/', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${adminAccessToken}`
                            // Content-Type заголовок не устанавливается вручную для FormData
                        },
                        body: formData
                    });
                    if (response.ok) {
                        showMessage('addFuturePlanMessage', 'Будущий план успешно добавлен!', 'success');
                        $('#addFuturePlanModal').modal('hide');
                        this.reset();
                        await fetchFuturePlans();
                    } else {
                        const errorData = await response.json();
                        showMessage('addFuturePlanMessage', `Ошибка добавления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error adding future plan:', error);
                    showMessage('addFuturePlanMessage', 'Ошибка сети при добавлении будущего плана.', 'danger');
                }
            });

            // Edit Future Plan Form Submission
            document.getElementById('editFuturePlanForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('editFuturePlanId').value;

                const formData = new FormData();
                formData.append('title', document.getElementById('editFuturePlanTitle').value);
                formData.append('description', document.getElementById('editFuturePlanDescription').value || '');
                formData.append('category', document.getElementById('editFuturePlanCategory').value || '');
                formData.append('is_active', document.getElementById('editFuturePlanIsActive').checked);

                const imageFile = document.getElementById('editFuturePlanImageFile').files[0];
                if (imageFile) {
                    formData.append('image_file', imageFile);
                }

                const videoFile = document.getElementById('editFuturePlanVideoFile').files[0];
                if (videoFile) {
                    formData.append('video_file', videoFile);
                }

                try {
                    const response = await fetch(`/api/admin/future_plans/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${adminAccessToken}`
                            // Content-Type заголовок не устанавливается вручную для FormData
                        },
                        body: formData
                    });
                    if (response.ok) {
                        showMessage('editFuturePlanMessage', 'Будущий план успешно обновлен!', 'success');
                        $('#editFuturePlanModal').modal('hide');
                        await fetchFuturePlans();
                    } else {
                        const errorData = await response.json();
                        showMessage('editFuturePlanMessage', `Ошибка обновления: ${errorData.detail || response.statusText}`, 'danger');
                    }
                } catch (error) {
                    console.error('Error updating future plan:', error);
                    showMessage('editFuturePlanMessage', 'Ошибка сети при обновлении будущего плана.', 'danger');
                }
            });


            // Load default section on page load
            loadSection('subscription-types');
        });
    </script>
</body>
</html>
